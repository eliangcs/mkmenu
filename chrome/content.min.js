/*   
 * Copyright 2011 Chang-Hung Liang
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
var NW=0,N=1,NE=2,E=3,SE=4,S=5,SW=6,W=7,$win=$(window),$doc=$(document),$body=$(document.body);function L(a,b){return chrome.i18n.getMessage(a,b)}
var Utils={COEF_X:[[-1,0,-1],[-0.5,0,0],[0,0,1],[0,0.5,0],[0,0,1],[-0.5,0,0],[-1,0,-1],[-1,-0.5,0]],COEF_Y:[[-1.5,-1],[-2.5,-2],[-1.5,-1],[-0.5,0],[0.5,1],[1.5,2],[0.5,1],[-0.5,0]],h2d:function(a){return parseInt(a,16)},d2h:function(a){a=a.toString(16);return a.length==1?"0"+a:a},parseColor:function(a){if(a[0]=="#"){if(a.length==4)return{r:this.h2d(a[1]+a[1]),g:this.h2d(a[2]+a[2]),b:this.h2d(a[3]+a[3]),a:1};if(a.length==7)return{r:this.h2d(a.substr(1,2)),g:this.h2d(a.substr(3,2)),b:this.h2d(a.substr(5,
2)),a:1}}else if(a.substr(0,3).toLowerCase()=="rgb")return a=a.substring(a.indexOf("("),a.indexOf(")")).split(","),{r:parseInt(a[0]),g:parseInt(a[1]),b:parseInt(a[2]),a:a[4]==void 0?1:Math.max(0,Math.min(1,parseFloat(a[4])))};return{r:0,g:0,b:0,a:1}},interp:function(a,b,c){return a+Math.min(1,Math.max(0,c))*(b-a)},interpColor:function(a,b,c){return this.colorStr({r:Math.round(this.interp(a.r,b.r,c)),g:Math.round(this.interp(a.g,b.g,c)),b:Math.round(this.interp(a.b,b.b,c)),a:this.interp(a.a,b.a,c)})},
colorStr:function(a){return a.a>0.999?"#"+this.d2h(a.r)+this.d2h(a.g)+this.d2h(a.b):"rgba("+a.r+","+a.g+","+a.b+","+a.a+")"},itemColor:function(a,b,c){return this.interpColor(a,b,[0.25,0,0.25,0.5,0.75,1,0.75,0.5][c])},itemPos:function(a,b,c,f,d,e){var g=Math.tan(Math.PI/8),e=e||0;return{x:Math.round(this.COEF_X[a][0]*b+this.COEF_X[a][1]*c/g+this.COEF_X[a][2]*(1.5+c+f)*g+(d||0)),y:Math.round(this.COEF_Y[a][0]*c+this.COEF_Y[a][1]*f+e)}},dragIdx:function(a,b){if(a*a+b*b<255)return-1;var c=Math.atan2(b,
a),c=Math.floor(4*c/Math.PI+3.5);if(c<0||c>7)c=7;return c},getContext:function(){var a=window.getSelection();return a.rangeCount>0&&a.getRangeAt(0).toString()!==""?"cmdsText":"cmdsBg"},ease:function(a){return a>=1?1:-Math.pow(2,-10*a)+1}},Cmds={cmdTop:function(){$win.scrollTop(0);return!1},cmdBottom:function(){$win.scrollTop($doc.height());return!1},cmdHome:function(){chrome.extension.sendRequest({name:"home"});return!1},cmdBack:function(){history.back();return!1},cmdForward:function(){history.forward();
return!1},cmdNewWindow:function(){chrome.extension.sendRequest({name:"newWin"});return!1},cmdNewTab:function(){chrome.extension.sendRequest({name:"newTab"});return!0},cmdNextTab:function(){chrome.extension.sendRequest({name:"nextTab"});return!0},cmdPrevTab:function(){chrome.extension.sendRequest({name:"prevTab"});return!0},search:function(a){var b=window.getSelection();b.rangeCount>0&&(b=b.getRangeAt(0).toString(),b!==""&&chrome.extension.sendRequest({name:"search",index:a,keyword:b}));return!1},
cmdSearch0:function(){return Cmds.search(0)},cmdSearch1:function(){return Cmds.search(1)},cmdSearch2:function(){return Cmds.search(2)},cmdSearch3:function(){return Cmds.search(3)},cmdSearch4:function(){return Cmds.search(4)},cmdSearch5:function(){return Cmds.search(5)},cmdSearch6:function(){return Cmds.search(6)},cmdSearch7:function(){return Cmds.search(7)}},Menu=function(a,b){var c=function(a){for(var b=[],c=0;c<a.length;c++)b.push(Utils.parseColor(a[c]));return b};this.prefs=a;this.bg=c(a.bg);this.fg=
c(a.fg);this.bounds={left:0,right:0,top:0,bottom:0};this.$div=$("<div class='mkmenu-menu'>").css({opacity:a.menuOpacity,position:"absolute",left:0,top:0,width:"auto",height:"auto",visibility:"hidden"});for(c=0;c<8;c++){var f=$("<div class='mkmenu-item'>").appendTo(this.$div).css({fontSize:a.font[0]+"pt",fontFamily:a.font[1],fontWeight:"normal",lineHeight:a.font[0]+"pt",background:Utils.itemColor(this.bg[0],this.bg[1],c),color:Utils.itemColor(this.fg[0],this.fg[1],c),padding:a.itemPadding[0]+"px "+
a.itemPadding[1]+"px",borderTop:a.bdrWidth+"px solid "+a.bdrColors[0],borderRight:a.bdrWidth+"px solid "+a.bdrColors[1],borderBottom:a.bdrWidth+"px solid "+a.bdrColors[2],borderLeft:a.bdrWidth+"px solid "+a.bdrColors[3],whiteSpace:"nowrap",cursor:"default",visibility:"hidden",position:"absolute",width:"auto",height:"auto",left:0,top:0});a.shadowColor&&f.css({"-webkit-box-shadow":"1px 1px 4px "+a.shadowColor});f=null;if(b=="cmdsText")f=a.searchEngines[c].name;this.command(c,a[b][c],f)}bounds=this.bounds;
this.attach();this.$div.children().each(function(b){var c=$(this),f=c.outerWidth(),m=c.outerHeight(),j=Utils.itemPos(b,f,m,a.itemSpace,0,0);if(b==1)bounds.top=Math.max(-j.y,bounds.top);else if(b==5)bounds.bottom=Math.max(j.y+m,bounds.bottom);if(b>=1&&b<=5)bounds.right=Math.max(j.x+f,bounds.right);if(b==0||b==1||b>=5&&b<=7)bounds.left=Math.max(-j.x,bounds.left);c.css({left:j.x+"px",top:j.y+"px"})});this.detach();this.$div.css("visibility","visible")};
Menu.prototype={command:function(a,b,c){if(a===void 0)if(this.$activeItem)a=this.$activeItem.index();else return"";a=this.$div.children().eq(a);if(b===void 0)return a.data("cmd");b===""||b===null?(a.removeData("cmd"),a.empty(),a.css("visibility","hidden")):(a.data("cmd",b),c?a.html(c):a.html(L(b)),a.css("visibility","inherit"));return this},css:function(a,b,c){var f=this.$div;c>=0&&(f=f.children().eq(c));f.css(a,b);return this},show:function(a){return this.css("visibility","visible",a)},hide:function(a){return this.css("visibility",
"hidden",a)},attach:function(a){this.$div.appendTo(a||document.body);return this},detach:function(){this.$div.detach();return this},offset:function(a,b){if(a===void 0)return{x:parseInt(this.$div.css("left")),y:parseInt(this.$div.css("top"))};this.$div.css({left:a+"px",top:b+"px"});return this},scale:function(a){if(a===void 0){var a=this.$div.css("-webkit-transform"),b=a.indexOf("scale(");return b>=0?parseFloat(a.substr(b+6)):1}this.$div.css({"-webkit-transform":"scale("+a+")"});return this},opacity:function(a,
b){var c=this.$div;b>=0&&(c=c.children().eq(b));return a>=0?(c.css("opacity",a),this):parseFloat(c.css("opacity"))},fadeIn:function(a,b){var c=this;b>=0?(this.opacity(0,b),this.show(i)):(this.scale(0),this.opacity(0));this.show();var f=(new Date).getTime(),c=this,d=function(){var e=((new Date).getTime()-f)/a,g=Utils.ease(e);b==void 0&&c.scale(g);c.opacity(g);e<1&&setTimeout(d,12)};d();return this},ghost:function(a,b,c,f){var d=this.$activeItem;if(!d)return this;var c=c||200,f=f||400,e=$(this.$div[0].cloneNode(!1)),
d=d.clone().appendTo(e),g=this.$div.parent();g&&e.appendTo(g);a!=void 0&&(g=e.offset(),a=Math.round(a+$win.scrollLeft()-g.left-d.outerWidth()/2),b=Math.round(b+$win.scrollTop()-g.top-d.outerHeight()/2),d.css({left:a+"px",top:b+"px"}),e.css("visibility","visible"));setTimeout(function(){e.animate({opacity:0},f,function(){$(this).remove()})},c);return this},mark:function(a){var b=function(a){if(a.$activeItem){var b=a.$activeItem.index();a.$activeItem.css({background:Utils.itemColor(a.bg[0],a.bg[1],
b),color:Utils.itemColor(a.fg[0],a.fg[1],b)})}};if(a>=0){if(!(this.$activeItem&&this.$activeItem.index()==a))b(this),this.$activeItem=this.$div.children().eq(a).css({background:this.prefs.bgActive,color:this.prefs.fgActive})}else b(this),this.$activeItem=null;return this}};var Canvas=function(a){this.prefs=a;this.$cvs=$("<canvas id='mkmenu-canvas'></canvas>").css({position:"absolute",left:0,top:0,background:"transparent"});this.clearRect=null};
Canvas.prototype={attach:function(a){a=a||document.body;this.$cvs.appendTo(a);return this},detach:function(){this.$cvs.detach();return this},resize:function(a,b){a=a||$win.width();b=b||$win.height();this.$cvs.attr({width:a,height:b});return this},ray:function(a,b,c,f){var d=this.$cvs[0].getContext("2d");if(this.clearRect!=null){var e=this.clearRect;d.clearRect(e.x,e.y,e.w,e.h)}d.lineCap="round";e=this.prefs;this._drawLine(d,e.rayBdrColor,e.rayBdrWidth,e.rayBdrOpacity,a,b,c,f);this._drawLine(d,e.rayColor,
e.rayWidth,e.rayOpacity,a,b,c,f);this.clearRect={x:Math.min(a,c)-2,y:Math.min(b,f)-2,w:Math.abs(a-c)+4,h:Math.abs(b-f)+4};return this},_drawLine:function(a,b,c,f,d,e,g,m){a.globalAlpha=f;a.strokeStyle=b;a.lineWidth=c;a.beginPath();a.moveTo(d,e);a.lineTo(g,m);a.closePath();a.stroke()}};var Container=function(){this.$div=$("<div id='mkmenu-container'>").css({position:"fixed",zIndex:1E6})};
Container.prototype={attach:function(a){this.$div.css({left:0,top:0}).appendTo(a||document.body);return this},detach:function(){this.$div.detach();return this}};
chrome.extension.sendRequest({name:"getPrefs"},function(a){var b=!1,c=null,f=0,d="cmdsBg,cmdsText,cmdsImg,cmdsLink,cmdsSubmit,cmdsEdit".split(","),e=new Container,g=new Canvas(a),m={},j;for(j in d)m[d[j]]=new Menu(a,d[j]);$doc.mousedown(function(d){if(d.button==2){c=Utils.getContext(d.target);var h=m[c];g.resize();var j=$win.width(),n=$win.height(),k=d.clientX,l=d.clientY;k-h.bounds.left<0?k+=h.bounds.left-k:k+h.bounds.right>j&&(k-=k+h.bounds.right-j);l-h.bounds.top<0?l+=h.bounds.top-l:l+h.bounds.bottom>
n&&(l-=l+h.bounds.bottom-n);h.offset(k,l);h.hide();h.attach(e.$div);e.attach();var o=function(){f=setTimeout(function(){b=!0;h.fadeIn(200)},a.popupDelay)};o();var p=d.clientX,q=d.clientY;$doc.bind("mousemove.mkmenu",function(a){g.attach(e.$div);if(b)var c=k,d=l;else c=p,d=q,clearTimeout(f),o();var j=Utils.dragIdx(a.clientX-c,a.clientY-d);h.mark(j);g.ray(c,d,a.clientX,a.clientY)})}});$doc.mouseup(function(d){$doc.unbind("mousemove.mkmenu");clearTimeout(f);if(d.button==2){g.detach();var h=m[c];if(h.$activeItem){if(!b){b=
!0;var j=d.clientX,n=d.clientY}var k=Cmds[h.command()],l=!1;k&&(l=k(a,d));l?e.detach():h.ghost(j,n,a.hideDelay,400,function(){e.detach()});g.detach()}else e.detach();h.detach();h.mark()}});$doc.bind("contextmenu",function(){if(b)return b=!1})});